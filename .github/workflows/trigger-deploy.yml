name: Trigger Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target deployment environment"
        required: true
        type: choice
        options:
          - nrd
          - mud
        default: "mud"
      key_vault_id:
        description: "Key Vault ID"
        required: true
        type: string
        default: "onland-metaverse-qa"
      secret_name:
        description: "Secret Name"
        required: true
        type: string
        default: "api-agora-secrets"
      release_name:
        description: "Helm release name"
        required: true
        type: string
        default: "qa"
      metaverse_namespace:
        description: "Kubernetes namespace where the app is installed"
        required: true
        type: string
        default: "qa"
      image_tag:
        type: string
        description: "Image tag"
        required: false
        default: "dev"
      branch:
        type: string
        description: "Branch to deploy"
        required: true
        default: "main"
      image_name:
        type: string
        description: "Docker image name"
        required: true
        default: "agora-node-token-server"

jobs:
  trigger_workflow:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'mud' }}
    steps:
      - name: Fetch Secrets
        id: fetch-secrets
        env:
          NRD_FUNCTION_URL: ${{ secrets.NRD_FUNCTION_URL }}
          NRD_FUNCTION_CODE: ${{ secrets.NRD_FUNCTION_CODE }}
          MUD_FUNCTION_URL: ${{ secrets.MUD_FUNCTION_URL }}
          MUD_FUNCTION_CODE: ${{ secrets.MUD_FUNCTION_CODE }}
        run: |
          TARGET_ENV_LOWER="${{ github.event.inputs.environment || 'mud' }}"
          PREFIX=$(echo "$TARGET_ENV_LOWER" | tr '[:lower:]' '[:upper:]')
          echo "Target environment selected: $TARGET_ENV_LOWER (Prefix: $PREFIX)"

          URL_VAR_NAME="${PREFIX}_FUNCTION_URL"
          CODE_VAR_NAME="${PREFIX}_FUNCTION_CODE"

          FUNCTION_URL="${!URL_VAR_NAME}"
          FUNCTION_CODE="${!CODE_VAR_NAME}"

          KEY_VAULT_ID="${{ github.event.inputs.key_vault_id }}"

          # Fetch GitHub actions secrets that include KUBECONFIG
          GH_ACTIONS_URL="$FUNCTION_URL?code=$FUNCTION_CODE&key_vault_id=$KEY_VAULT_ID&name=github-actions"
          GH_ACTIONS_RESPONSE=$(curl -s -H "Content-Type: application/json" -X GET "$GH_ACTIONS_URL")
          
          if [ -z "$GH_ACTIONS_RESPONSE" ]; then
              echo "Failed to retrieve GitHub Actions secrets from Function."
              exit 1
          fi
          
          # Remove "Secret value: " prefix if present
          GH_ACTIONS_SECRETS=$(echo "$GH_ACTIONS_RESPONSE" | sed 's/^Secret value: //')
          
          # Parse key-value pairs from the response
          REGISTRY_SERVER=$(echo "$GH_ACTIONS_SECRETS" | grep "^REGISTRY_SERVER=" | cut -d'=' -f2)
          
          # Validate that required values were extracted
          if [ -z "$REGISTRY_SERVER" ]; then
              echo "Failed to extract required registry credentials from secrets"
              exit 1
          fi

          # Put the REGISTRY_SERVER in the $GITHUB_ENV
          echo "REGISTRY_SERVER=$REGISTRY_SERVER" >> $GITHUB_ENV

      - name: Trigger Helm Chart deployment
        uses: convictional/trigger-workflow-and-wait@v1.6.1
        with:
          owner: ${{ github.repository_owner }}
          repo: metaverse-helm-charts
          github_token: ${{ secrets.ORG_TOKEN }}
          workflow_file_name: deploy.yaml
          ref: ${{ github.event.inputs.branch }}
          wait_interval: 20
          propagate_failure: true
          trigger_workflow: true
          wait_workflow: true
          client_payload: '{"image_tag": "${{ github.event.inputs.image_tag }}", "key_vault_id": "${{ github.event.inputs.key_vault_id }}", "secret_name": "${{ github.event.inputs.secret_name }}", "app_to_deploy": "agora-token-server", "release_name": "${{ github.event.inputs.release_name }}", "metaverse_namespace": "${{ github.event.inputs.metaverse_namespace }}", "image_registry": "${{ env.REGISTRY_SERVER }}", "image_name": "${{ github.event.inputs.image_name }}", "environment": "${{ github.event.inputs.environment }}"}'